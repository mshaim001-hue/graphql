<!DOCTYPE html>
<html>
<head>
    <title>Debug Audits</title>
</head>
<body>
    <h1>Debug Audits</h1>
    <div id="output"></div>
    
    <script>
        async function debugAudits() {
            const apiUrl = 'https://01.tomorrow-school.ai/api/graphql-engine/v1/graphql';
            const jwt = localStorage.getItem('jwt');
            const userId = localStorage.getItem('userId');
            
            if (!jwt || !userId) {
                document.getElementById('output').innerHTML = '<p>No JWT or userId found. Please login first.</p>';
                return;
            }
            
            console.log('JWT:', jwt);
            console.log('UserID:', userId);
            
            const query = `
                query {
                    audit(where: {auditorId: {_eq: ${userId}}}) {
                        id
                        grade
                        createdAt
                        result {
                            id
                            object {
                                name
                                type
                                authorId
                            }
                        }
                        group {
                            id
                        }
                    }
                }
            `;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwt}`
                    },
                    body: JSON.stringify({ query })
                });
                
                const data = await response.json();
                console.log('Raw response:', data);
                
                if (data.errors) {
                    document.getElementById('output').innerHTML = '<h2>GraphQL Errors:</h2><pre>' + JSON.stringify(data.errors, null, 2) + '</pre>';
                    return;
                }
                
                const audits = data.data.audit || [];
                console.log('Audits count:', audits.length);
                console.log('Audits data:', audits);
                
                // Analyze the data
                const analysis = {
                    total: audits.length,
                    uniqueIds: [...new Set(audits.map(a => a.id))].length,
                    duplicates: audits.length - [...new Set(audits.map(a => a.id))].length,
                    withResults: audits.filter(a => a.result).length,
                    withoutResults: audits.filter(a => !a.result).length,
                    withObjects: audits.filter(a => a.result?.object).length,
                    withAuthorIds: audits.filter(a => a.result?.object?.authorId).length,
                    sampleAudits: audits.slice(0, 5).map(audit => ({
                        id: audit.id,
                        grade: audit.grade,
                        date: audit.createdAt,
                        projectName: audit.result?.object?.name || 'No result/object',
                        authorId: audit.result?.object?.authorId || 'No authorId',
                        hasResult: !!audit.result,
                        hasObject: !!audit.result?.object
                    }))
                };
                
                document.getElementById('output').innerHTML = `
                    <h2>Analysis Results:</h2>
                    <pre>${JSON.stringify(analysis, null, 2)}</pre>
                    
                    <h2>All Audit IDs:</h2>
                    <p>${audits.map(a => a.id).join(', ')}</p>
                    
                    <h2>Sample Audits:</h2>
                    <pre>${JSON.stringify(analysis.sampleAudits, null, 2)}</pre>
                `;
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('output').innerHTML = '<p>Error: ' + error.message + '</p>';
            }
        }
        
        // Run when page loads
        debugAudits();
    </script>
</body>
</html>
